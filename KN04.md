# KN 04

### Cloud-Config

~~~yaml
#cloud-config
users:
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    home: /home/ubuntu
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC6CnvM5Utz8IaE9OoXqrsxaoblT7iuWG6I5KvWQ/SSOWmln3Y45tc7+0aA5maL2gKm/PE3n3dHb8eKM6/SsxYVjMncsRZ5QVL+mf7wVI7Q3ibdNJGq7FjDrCgqaiYlDbQx96H2/ai0/QuhDMI0loRo3Of3mk8eeVL5HceaTLJGtreJdaM0Sh5vAjoTJL3+HneLBKdS2meeiVpiPF1bf8q9E9Iak6aHDToL80PFRD/5WYRH7w9wxRCyMdD7ZOBkWmK0qvSF2mPsj6ngGTVY39kMcNVwfEnpt+o+B+VOQTQUKvA4MY98PAdXZft4HlLHj5B8jhRrNKXTRea/cgwxA2br
ssh_pwauth: false
disable_root: false 
package_update: true
packages:
  - curl 
  - wget 
~~~

### Cloud-Config Erklärung

Diese Cloud-Config macht Folgendes:

- users: legt alle Benutzer an
- name: Benutzername
- sudo: welche Befehle der Benutzer mit `sudo` ausführen darf
- groups: die Gruppen der Benutzer drinnen ist
- home: persönliche Ordner des Benutzers
- shell: welche Shell der Benutzer nutzt
- ssh_authorized_keys: öffentliche SSH-Schlüssel
- ssh_pwauth: legt fest, ob man sich mit Passwort anmelden darf
- disable_root: bestimmt, ob der Root-Account deaktiviert ist
- package_update: aktualisiert die Paketlisten
- packages: Liste von Packages die an will

eron - cloud-init

eron1 - eigenschaft in einst

## Public Key erzeugen

```bash
icacls eron.pem /inheritance:r /grant:r "%USERNAME%:F"
icacls eron1.pem /inheritance:r /grant:r "%USERNAME%:F"

ssh-keygen -y -f eron.pem > eron.pub
ssh-keygen -y -f eron1.pem > eron1.pub
```

### Cloud-Config

```yaml
#cloud-config
users:
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    home: /home/ubuntu
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC6CnvM5Utz8IaE9OoXqrsxaoblT7iuWG6I5KvWQ/SSOWmln3Y45tc7+0aA5maL2gKm/PE3n3dHb8eKM6/SsxYVjMncsRZ5QVL+mf7wVI7Q3ibdNJGq7FjDrCgqaiYlDbQx96H2/ai0/QuhDMI0loRo3Of3mk8eeVL5HceaTLJGtreJdaM0Sh5vAjoTJL3+HneLBKdS2meeiVpiPF1bf8q9E9Iak6aHDToL80PFRD/5WYRH7w9wxRCyMdD7ZOBkWmK0qvSF2mPsj6ngGTVY39kMcNVwfEnpt+o+B+VOQTQUKvA4MY98PAdXZft4HlLHj5B8jhRrNKXTRea/cgwxA2br
ssh_pwauth: false
disable_root: false
package_update: true
packages:
  - curl
  - wget
```

## Mit zusätzlichem Key

```yaml
#cloud-config
users:
  - name: ubuntu
    sudo: ALL=(ALL) NOPASSWD:ALL
    groups: users, admin
    home: /home/ubuntu
    shell: /bin/bash
    ssh_authorized_keys:
      - ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC6CnvM5Utz8IaE9OoXqrsxaoblT7iuWG6I5KvWQ/SSOWmln3Y45tc7+0aA5maL2gKm/PE3n3dHb8eKM6/SsxYVjMncsRZ5QVL+mf7wVI7Q3ibdNJGq7FjDrCgqaiYlDbQx96H2/ai0/QuhDMI0loRo3Of3mk8eeVL5HceaTLJGtreJdaM0Sh5vAjoTJL3+HneLBKdS2meeiVpiPF1bf8q9E9Iak6aHDToL80PFRD/5WYRH7w9wxRCyMdD7ZOBkWmK0qvSF2mPsj6ngGTVY39kMcNVwfEnpt+o+B+VOQTQUKvA4MY98PAdXZft4HlLHj5B8jhRrNKXTRea/cgwxA2br
      - "Lehrer Key"
ssh_pwauth: false
disable_root: false
package_update: true
packages:
  - curl
  - wget
```

## Instanzen einrichten

### Datenbank
- Datei: `cloud-init-db.yaml`
- Installiert: MariaDB-Server  
- Admin-Benutzer anlegen  
- Remote-Zugriff aktivieren:  
  ```bash
  sudo sed -i 's/127.0.0.1/0.0.0.0/g' /etc/mysql/mariadb.conf.d/50-server.cnf
  ```

**Abgabe:**
- Cloud-Init im Git  
- Screenshot Konfiguration  

### Webserver
- Datei: `cloud-init-web.yaml`
- Installiert: Apache2, PHP, PHP-MySQL, Adminer  
- Dateien mit `write_files`:  
  - index.html  
  - info.php  
  - db.php  

Befehle:  
```bash
sudo a2enconf adminer
sudo systemctl restart apache2
```

### Debugging
- Log: `/var/log/cloud-init-output.log`  
- DB-Test: `mysql -u admin -p`  
- Port-Test: `telnet <IP> 3306`